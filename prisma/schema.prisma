// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id              String    @id @default(uuid())
  email           String    @unique
  passwordHash    String
  name            String
  university      String
  orcid           String?   @unique
  role            String    @default("author") // author, reviewer, editor, super_admin
  affiliation     String?
  bio             String?
  profileImageUrl String?
  isEmailVerified Boolean   @default(false)
  isActive        Boolean   @default(true)
  lastLoginAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  articles                Article[]
  reviews                 Review[]
  conferences             ConferenceRegistration[]
  dissertations           Dissertation[]
  membership              Membership?
  notifications           Notification[]
  passwordResetTokens     PasswordResetToken[]
  emailVerificationTokens EmailVerificationToken[]
  blogs                   Blog[]
  downloads               DownloadLog[]

  @@index([email])
  @@index([role])
}

// Password Reset Tokens
model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique
  expiresAt DateTime
  used      Boolean   @default(false)
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

// Email Verification Tokens
model EmailVerificationToken {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique
  expiresAt DateTime
  used      Boolean   @default(false)
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

// Memberships
model Membership {
  id                   String   @id @default(uuid())
  userId               String   @unique
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tier                 String // free, basic, premium, institutional
  status               String   @default("active") // active, expired, cancelled
  startDate            DateTime
  endDate              DateTime
  autoRenew            Boolean  @default(true)
  stripeSubscriptionId String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

// Journals
model Journal {
  id                      String    @id @default(uuid())
  code                    String    @unique // JITMB, JSAE, etc.
  fullName                String
  shortName               String?
  description             String?
  aimsAndScope            String?
  coverImageUrl           String?
  issn                    String?
  eIssn                   String?
  impactFactor            Float?
  citeScore               Float?
  publisher               String?
  frequency               String?
  articleProcessingCharge Float?
  themeColor              String?   @default("#006d77") // Default teal color
  
  // Journal Insights
  subjectAreas            String?   @db.Text
  indexing                String?   @db.Text
  
  // Content Pages
  editorialBoard          Json?     // [{ name: "...", role: "...", affiliation: "...", image: "..." }]
  editorialBoardDescription String? @db.Text
  editingService          String?   @db.Text
  
  // Timeline Metrics
  timeToFirstDecision     String?
  reviewTime              String?
  revisionTime            String?
  submissionToAcceptance  String?
  acceptanceToPublication String?

  isActive                Boolean   @default(true)
  displayOrder            Int       @default(0)
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  deletedAt               DateTime?

  articles Article[]
  issues   JournalIssue[]

  @@index([code])
  @@index([isActive])
}

model JournalIssue {
  id          String   @id @default(uuid())
  journalId   String
  journal     Journal  @relation(fields: [journalId], references: [id])
  title       String?  // e.g. "Special Issue on AI"
  volume      Int
  issue       Int
  year        Int
  coverUrl    String?
  isSpecial   Boolean  @default(false)
  isCurrent   Boolean  @default(false)
  description String?  @db.Text
  publishedAt DateTime @default(now())
  
  articles    Article[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([journalId])
  @@index([year])
}

// Articles
model Article {
  id              String        @id @default(uuid())
  journalId       String
  journal         Journal       @relation(fields: [journalId], references: [id])
  issueId         String?
  journalIssue    JournalIssue? @relation(fields: [issueId], references: [id])
  title           String
  abstract        String
  keywords        String[]
  articleType     String // research, review, case_study
  doi             String?   @unique
  volume          Int?
  issue           Int?
  pageStart       Int?
  pageEnd         Int?
  publicationDate DateTime?
  submissionDate  DateTime?
  acceptanceDate  DateTime?
  status          String    @default("draft") // draft, submitted, under_review, waiting_for_editor, revision_requested, resubmitted, waiting_for_final_decision, accepted, published, rejected
  pdfUrl          String?
  language        String    @default("en")
  citationCount   Int       @default(0)
  viewCount       Int       @default(0)
  downloadCount   Int       @default(0)
  isOpenAccess    Boolean   @default(true)
  isBestPaper     Boolean   @default(false)
  
  // New workflow fields
  editorComments    String?
  rejectionReason   String?
  resubmissionCount Int       @default(0)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  authorId String
  author   User     @relation(fields: [authorId], references: [id])
  reviews  Review[]
  coAuthors CoAuthor[]

  @@index([journalId])
  @@index([status])
  @@index([publicationDate])
  @@index([authorId])
}

// Co-Authors
model CoAuthor {
  id           String   @id @default(uuid())
  articleId    String
  article      Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  name         String
  email        String?
  university   String?
  isMain       Boolean  @default(false)
  order        Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([articleId])
}

// Reviews
model Review {
  id               String    @id @default(uuid())
  articleId        String
  article          Article   @relation(fields: [articleId], references: [id], onDelete: Cascade)
  reviewerId       String
  reviewer         User      @relation(fields: [reviewerId], references: [id])
  reviewerNumber   Int 
  round            Int       @default(1)
  status           String    @default("invited") // invited, accepted, declined, pending, in_progress, completed
  decision         String?   // accept, partial_accept, reject
  commentsToAuthor String?
  commentsToEditor String?
  assignedAt       DateTime  @default(now())
  dueDate          DateTime?
  submittedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([articleId, reviewerNumber])
  @@index([articleId])
  @@index([reviewerId])
  @@index([status])
}

// Dissertations
model Dissertation {
  id             String    @id @default(uuid())
  title          String
  abstract       String
  authorId       String
  author         User      @relation(fields: [authorId], references: [id])
  authorName     String?
  university     String
  department     String?
  degreeType     String // masters, phd
  supervisorName String?
  submissionDate DateTime?
  defenseDate    DateTime?
  keywords       String[]
  pdfUrl         String?
  coverImageUrl  String?
  status         String    @default("pending") // pending, approved, published
  viewCount      Int       @default(0)
  downloadCount  Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  @@index([authorId])
  @@index([degreeType])
  @@index([status])
}

// Conferences
model Conference {
  id                 String    @id @default(uuid())
  title              String
  acronym            String?
  description        String?
  fullDescription    String?   // For the detailed about section
  startDate          DateTime
  endDate            DateTime
  venue              String?
  city               String?
  country            String?
  location           String?   // e.g. "San Francisco, USA" displayed in list
  websiteUrl         String?
  registrationUrl    String?
  submissionDeadline DateTime?
  notificationDate   DateTime?
  conferenceType     String?   // virtual, in_person, hybrid
  status             String    @default("upcoming") // upcoming, ongoing, completed, cancelled
  bannerImageUrl     String?
  
  topics             String[]
  keynotes           Json?     // [{ name: "...", title: "...", topic: "..." }]
  schedule           Json?     // [{ day: "...", events: [...] }]
  registrationFees   Json?     // { earlyBird: {...}, regular: {...} }
  included           String[]  // Strings of what's included
  importantDates     Json?     // [{ event: "...", date: "..." }]
  venueDetails       Json?     // { name: "...", address: "...", hotels: [...] }

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  deletedAt          DateTime?

  registrations ConferenceRegistration[]

  @@index([startDate])
  @@index([status])
}

// Conference Registrations
model ConferenceRegistration {
  id               String     @id @default(uuid())
  conferenceId     String
  conference       Conference @relation(fields: [conferenceId], references: [id], onDelete: Cascade)
  userId           String
  user             User       @relation(fields: [userId], references: [id])
  registrationType String // student, academic, industry
  paymentStatus    String     @default("pending") // pending, completed, failed
  paymentAmount    Float?
  stripePaymentId  String?
  registeredAt     DateTime   @default(now())
  createdAt        DateTime   @default(now())

  @@index([conferenceId])
  @@index([userId])
}

// Blogs
model Blog {
  id               String    @id @default(uuid())
  title            String
  slug             String    @unique
  content          String
  excerpt          String?
  featuredImageUrl String?
  authorId         String
  author           User      @relation(fields: [authorId], references: [id])
  status           String    @default("draft") // draft, published
  publishedAt      DateTime?
  viewCount        Int       @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime?

  @@index([slug])
  @@index([status])
  @@index([publishedAt])
}

// Announcements
model Announcement {
  id           String    @id @default(uuid())
  title        String
  content      String
  excerpt      String?
  thumbnailUrl String?
  category     String? // news, update, event
  priority     Int       @default(0)
  isFeatured   Boolean   @default(false)
  author       String?   @default("IJAISM Admin")
  publishedAt  DateTime?
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  @@index([category])
  @@index([isFeatured])
  @@index([publishedAt])
}

// Notifications
model Notification {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String // submission_update, review_request, message
  title     String
  message   String
  link      String?
  isRead    Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// Books
model Book {
  id              String    @id @default(uuid())
  title           String
  authors         String[]
  year            Int
  isbn            String    @unique
  pages           Int
  field           String
  description     String
  fullDescription String
  price           String    // Storing as string to handle currency symbols/formatting easily as per mock
  publisher       String
  language        String
  edition         String
  format          String
  coverImageUrl   String?
  
  tableOfContents Json?     // [{ chapter: 1, title: "...", pages: "..." }]
  previewPages    Json?     // [{ pageNumber: 1, content: "..." }]
  reviews         Json?     // [{ author: "...", rating: 5, text: "..." }]
  relatedTopics   String[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([isbn])
  @@index([field])
}

// Download Tracking
model DownloadLog {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  resourceId  String
  resourceType String  // 'article', 'dissertation', etc.
  downloadedAt DateTime @default(now())

  @@index([userId])
  @@index([downloadedAt])
}
