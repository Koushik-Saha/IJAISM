generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String                   @id @default(uuid())
  email                   String                   @unique
  passwordHash            String
  name                    String
  university              String
  orcid                   String?                  @unique
  role                    String                   @default("author")
  affiliation             String?
  bio                     String?
  profileImageUrl         String?
  isEmailVerified         Boolean                  @default(false)
  isActive                Boolean                  @default(true)
  lastLoginAt             DateTime?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  deletedAt               DateTime?
  managedById             String?
  articles                Article[]
  blogs                   Blog[]
  conferences             ConferenceRegistration[]
  dissertations           Dissertation[]
  downloads               DownloadLog[]
  emailVerificationTokens EmailVerificationToken[]
  managedJournals         Journal[]                @relation("JournalEditor")
  membership              Membership?
  notifications           Notification[]
  passwordResetTokens     PasswordResetToken[]
  reviews                 Review[]
  managedBy               User?                    @relation("UserHierarchy", fields: [managedById], references: [id])
  subordinates            User[]                   @relation("UserHierarchy")

  @@index([email])
  @@index([role])
  @@index([managedById])
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  used      Boolean   @default(false)
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model EmailVerificationToken {
  id        String    @id @default(uuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  used      Boolean   @default(false)
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model Membership {
  id                   String   @id @default(uuid())
  userId               String   @unique
  tier                 String
  status               String   @default("active")
  startDate            DateTime
  endDate              DateTime
  autoRenew            Boolean  @default(true)
  stripeSubscriptionId String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model Journal {
  id                        String         @id @default(uuid())
  code                      String         @unique
  fullName                  String
  shortName                 String?
  description               String?
  aimsAndScope              String?
  coverImageUrl             String?
  issn                      String?
  eIssn                     String?
  impactFactor              Float?
  publisher                 String?
  frequency                 String?
  articleProcessingCharge   Float?
  isActive                  Boolean        @default(true)
  displayOrder              Int            @default(0)
  createdAt                 DateTime       @default(now())
  updatedAt                 DateTime       @updatedAt
  deletedAt                 DateTime?
  citeScore                 Float?
  themeColor                String?        @default("#006d77")
  acceptanceToPublication   String?
  indexing                  String?
  reviewTime                String?
  revisionTime              String?
  subjectAreas              String?
  submissionToAcceptance    String?
  timeToFirstDecision       String?
  editingService            String?
  editorialBoard            Json?
  editorialBoardDescription String?
  editorId                  String?
  articles                  Article[]
  editor                    User?          @relation("JournalEditor", fields: [editorId], references: [id])
  issues                    JournalIssue[]

  @@index([code])
  @@index([isActive])
  @@index([editorId])
}

model JournalIssue {
  id          String    @id @default(uuid())
  journalId   String
  title       String?
  volume      Int
  issue       Int
  year        Int
  coverUrl    String?
  isSpecial   Boolean   @default(false)
  isCurrent   Boolean   @default(false)
  description String?
  publishedAt DateTime  @default(now())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  articles    Article[]
  journal     Journal   @relation(fields: [journalId], references: [id])

  @@index([journalId])
  @@index([year])
}

model Article {
  id                String        @id @default(uuid())
  journalId         String
  title             String
  abstract          String
  keywords          String[]
  articleType       String
  doi               String?       @unique
  volume            Int?
  issue             Int?
  pageStart         Int?
  pageEnd           Int?
  publicationDate   DateTime?
  submissionDate    DateTime?
  acceptanceDate    DateTime?
  status            String        @default("draft")
  pdfUrl            String?
  language          String        @default("en")
  citationCount     Int           @default(0)
  viewCount         Int           @default(0)
  downloadCount     Int           @default(0)
  isOpenAccess      Boolean       @default(true)

  createdAt         DateTime      @default(now())
  reviewerInvitations ReviewerInvitation[]
  updatedAt         DateTime      @updatedAt
  isApcPaid         Boolean       @default(false)
  apcAmount         Float?
  stripePaymentId   String?       // For Payment Tracking
  deletedAt         DateTime?
  authorId          String
  editorComments    String?
  rejectionReason   String?
  resubmissionCount Int           @default(0)
  issueId           String?
  isBestPaper       Boolean       @default(false)
  author            User          @relation(fields: [authorId], references: [id])
  journalIssue      JournalIssue? @relation(fields: [issueId], references: [id])
  journal           Journal       @relation(fields: [journalId], references: [id])
  coAuthors         CoAuthor[]
  reviews           Review[]

  @@index([journalId])
  @@index([status])
  @@index([publicationDate])
  @@index([authorId])
}

model CoAuthor {
  id         String   @id @default(uuid())
  articleId  String
  name       String
  email      String?
  university String?
  isMain     Boolean  @default(false)
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  article    Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([articleId])
}

model Review {
  id               String    @id @default(uuid())
  articleId        String
  reviewerId       String
  reviewerNumber   Int
  round            Int       @default(1)
  status           String    @default("invited")
  decision         String?
  commentsToAuthor String?
  commentsToEditor String?
  assignedAt       DateTime  @default(now())
  dueDate          DateTime?
  submittedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  article          Article   @relation(fields: [articleId], references: [id], onDelete: Cascade)
  reviewer         User      @relation(fields: [reviewerId], references: [id])

  @@unique([articleId, reviewerNumber])
  @@index([articleId])
  @@index([reviewerId])
  @@index([status])
}

model Dissertation {
  id             String    @id @default(uuid())
  title          String
  abstract       String
  authorId       String
  university     String
  department     String?
  degreeType     String
  supervisorName String?
  submissionDate DateTime?
  defenseDate    DateTime?
  keywords       String[]
  pdfUrl         String?
  status         String    @default("pending")
  viewCount      Int       @default(0)
  downloadCount  Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?
  coverImageUrl  String?
  authorName     String?
  author         User      @relation(fields: [authorId], references: [id])

  @@index([authorId])
  @@index([degreeType])
  @@index([status])
}

model Conference {
  id                 String                   @id @default(uuid())
  title              String
  description        String?
  startDate          DateTime
  endDate            DateTime
  venue              String?
  city               String?
  country            String?
  websiteUrl         String?
  registrationUrl    String?
  submissionDeadline DateTime?
  notificationDate   DateTime?
  conferenceType     String?
  status             String                   @default("upcoming")
  bannerImageUrl     String?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  deletedAt          DateTime?
  acronym            String?
  fullDescription    String?
  importantDates     Json?
  included           String[]
  keynotes           Json?
  location           String?
  registrationFees   Json?
  schedule           Json?
  topics             String[]
  venueDetails       Json?
  registrations      ConferenceRegistration[]

  @@index([startDate])
  @@index([status])
}

model ConferenceRegistration {
  id               String     @id @default(uuid())
  conferenceId     String
  userId           String
  registrationType String
  paymentStatus    String     @default("pending")
  paymentAmount    Float?
  stripePaymentId  String?
  registeredAt     DateTime   @default(now())
  createdAt        DateTime   @default(now())
  conference       Conference @relation(fields: [conferenceId], references: [id], onDelete: Cascade)
  user             User       @relation(fields: [userId], references: [id])

  @@index([conferenceId])
  @@index([userId])
}

model Blog {
  id               String    @id @default(uuid())
  title            String
  slug             String    @unique
  content          String
  excerpt          String?
  featuredImageUrl String?
  authorId         String
  status           String    @default("draft")
  publishedAt      DateTime?
  viewCount        Int       @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime?
  author           User      @relation(fields: [authorId], references: [id])

  @@index([slug])
  @@index([status])
  @@index([publishedAt])
}

model Announcement {
  id           String    @id @default(uuid())
  title        String
  content      String
  excerpt      String?
  thumbnailUrl String?
  category     String?
  priority     Int       @default(0)
  isFeatured   Boolean   @default(false)
  publishedAt  DateTime?
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?
  author       String?   @default("IJAISM Admin")

  @@index([category])
  @@index([isFeatured])
  @@index([publishedAt])
}

model Notification {
  id        String    @id @default(uuid())
  userId    String
  type      String
  title     String
  message   String
  link      String?
  isRead    Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model Book {
  id              String   @id @default(uuid())
  title           String
  authors         String[]
  year            Int
  isbn            String   @unique
  pages           Int
  field           String
  description     String
  fullDescription String
  price           String
  publisher       String
  language        String
  edition         String
  format          String
  coverImageUrl   String?
  tableOfContents Json?
  previewPages    Json?
  reviews         Json?
  relatedTopics   String[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([isbn])
  @@index([field])
}

model DownloadLog {
  id           String   @id @default(uuid())
  userId       String
  resourceId   String
  resourceType String
  downloadedAt DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([downloadedAt])
}

model ReviewerInvitation {
  id        String   @id @default(uuid())
  email     String
  name      String
  articleId String
  token     String   @unique
  status    String   @default("pending") // pending, accepted, expired
  createdAt DateTime @default(now())
  expiresAt DateTime
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([token])
}
